rules_version = '2';

/**
 * Firestore Security Rules for OphthalmoSim+
 * ==========================================
 * 
 * Security Features:
 * 1. Role-Based Access Control (RBAC): admin, supervisor, trainee, guest
 * 2. User data isolation - users can only access their own data
 * 3. Audit logging for all sensitive operations
 * 4. Data validation and sanitization
 * 5. No deletion allowed - preserve all medical training data
 * 6. Rate limiting through Firebase App Check (configure separately)
 * 
 * Roles:
 * - admin: Full access to all data, can manage users
 * - supervisor: Can view trainee progress, manage schedules
 * - trainee: Can access own data, simulations, OKAP games
 * - guest: Read-only access to public content
 * 
 * Deploy with: firebase deploy --only firestore:rules
 */

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ================================================================
    // HELPER FUNCTIONS
    // ================================================================
    
    // Check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Get user's role from their profile
    function getUserRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }
    
    // Check if user has specific role
    function hasRole(role) {
      return isAuthenticated() && getUserRole() == role;
    }
    
    // Check if user is admin
    function isAdmin() {
      return hasRole('admin');
    }
    
    // Check if user is supervisor or higher
    function isSupervisorOrHigher() {
      return isAuthenticated() && (getUserRole() in ['admin', 'supervisor']);
    }
    
    // Check if user owns the document
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Validate timestamp is server timestamp
    function isServerTimestamp(field) {
      return field == request.time;
    }
    
    // ================================================================
    // VALIDATION FUNCTIONS
    // ================================================================
    
    // Validate new user profile structure
    function validateUserProfile(data) {
      return data.keys().hasAll(['uid', 'idNumber', 'fullName', 'specialty', 'createdAt', 'stats', 'role'])
             && data.uid is string
             && data.uid == request.auth.uid
             && data.idNumber is string
             && data.idNumber.size() >= 5
             && data.fullName is string
             && data.fullName.size() >= 2
             && data.fullName.size() <= 100
             && data.specialty is string
             && data.stats is map
             && data.role in ['trainee', 'supervisor', 'admin'];
    }
    
    // Validate user update (only allow stats changes, not role)
    function validateUserUpdate(newData, oldData) {
      return newData.uid == oldData.uid
             && newData.idNumber == oldData.idNumber
             && newData.fullName == oldData.fullName
             && newData.specialty == oldData.specialty
             && newData.createdAt == oldData.createdAt
             && newData.role == oldData.role  // Role cannot be self-changed
             && newData.stats is map
             && (newData.stats.practice_count >= oldData.stats.practice_count 
                 || !('practice_count' in oldData.stats));
    }
    
    // Validate simulation result data
    function validateSimulationResult(data) {
      return data.keys().hasAll(['userId', 'simulationId', 'score', 'timestamp', 'duration'])
             && data.userId == request.auth.uid
             && data.simulationId is string
             && data.score is number
             && data.score >= 0
             && data.score <= 100
             && data.duration is number
             && data.duration > 0;
    }
    
    // Validate OKAP game result
    function validateOkapResult(data) {
      return data.keys().hasAll(['userId', 'gameId', 'score', 'accuracy', 'timestamp'])
             && data.userId == request.auth.uid
             && data.gameId is string
             && data.score is number
             && data.accuracy is number
             && data.accuracy >= 0
             && data.accuracy <= 100;
    }
    
    // ================================================================
    // USERS COLLECTION
    // ================================================================
    match /users/{userId} {
      // Users can read their own profile, admins can read all
      allow read: if isOwner(userId) || isAdmin();
      
      // Users can create their own profile on registration
      allow create: if isAuthenticated() 
                    && request.auth.uid == userId
                    && validateUserProfile(request.resource.data);
      
      // Users can update their own profile (stats only), admins can update any
      allow update: if (isOwner(userId) && validateUserUpdate(request.resource.data, resource.data))
                    || isAdmin();
      
      // Never allow delete - preserve all user data for compliance
      allow delete: if false;
    }
    
    // ================================================================
    // LEADERBOARD ACCESS (Limited fields)
    // ================================================================
    match /users/{userId} {
      // Any authenticated user can list users for leaderboard
      allow list: if isAuthenticated();
    }
    
    // ================================================================
    // SIMULATION RESULTS
    // ================================================================
    match /simulations/{resultId} {
      // Users can read their own results, supervisors can read their trainees
      allow read: if isOwner(resource.data.userId) || isSupervisorOrHigher();
      
      // Users can create their own simulation results
      allow create: if isAuthenticated() 
                    && validateSimulationResult(request.resource.data);
      
      // No updates or deletes - results are immutable
      allow update, delete: if false;
    }
    
    // ================================================================
    // OKAP GAME RESULTS
    // ================================================================
    match /okap_results/{resultId} {
      allow read: if isOwner(resource.data.userId) || isSupervisorOrHigher();
      
      allow create: if isAuthenticated() 
                    && validateOkapResult(request.resource.data);
      
      allow update, delete: if false;
    }
    
    // ================================================================
    // ROTA / SCHEDULING
    // ================================================================
    match /schedules/{scheduleId} {
      // All authenticated users can read schedules
      allow read: if isAuthenticated();
      
      // Only supervisors and admins can create/update schedules
      allow create, update: if isSupervisorOrHigher();
      
      allow delete: if false;
    }
    
    match /swap_listings/{listingId} {
      allow read: if isAuthenticated();
      
      // Users can create their own swap listings
      allow create: if isAuthenticated() 
                    && request.resource.data.userId == request.auth.uid;
      
      // Users can update their own listings (cancel), or accept others
      allow update: if isAuthenticated();
      
      allow delete: if false;
    }
    
    // ================================================================
    // PREFERENCES
    // ================================================================
    match /preferences/{prefId} {
      allow read: if isOwner(resource.data.userId) || isSupervisorOrHigher();
      
      allow create, update: if isAuthenticated() 
                           && request.resource.data.userId == request.auth.uid;
      
      allow delete: if false;
    }
    
    // ================================================================
    // AUDIT LOGS (Write-only, admin read)
    // ================================================================
    match /audit_logs/{logId} {
      // Only admins can read audit logs
      allow read: if isAdmin();
      
      // Any authenticated user can create audit logs (system writes)
      allow create: if isAuthenticated();
      
      // Audit logs are immutable
      allow update, delete: if false;
    }
    
    // ================================================================
    // ANALYTICS (Aggregated data)
    // ================================================================
    match /analytics/{docId} {
      allow read: if isSupervisorOrHigher();
      allow write: if isAdmin();
    }
    
    // ================================================================
    // BLOCK EVERYTHING ELSE
    // ================================================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
